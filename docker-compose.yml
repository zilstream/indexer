version: '3.8'

services:
  indexer:
    image: zilstream-indexer:latest
    build: .
    platform: linux/amd64
    container_name: zilstream-indexer
    environment:
      # Use host DB instead of a containerized one
      INDEXER_DATABASE_HOST: host.docker.internal
      CENTRIFUGO_API_URL: http://centrifugo:8001/api
      CENTRIFUGO_WS_URL: ws://localhost:8001/connection/websocket
    volumes:
      - ./config.yaml:/app/config.yaml:ro
      - ./manifests:/app/manifests:ro
    ports:
      - "9090:9090"  # health + status (indexer only)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - centrifugo
    restart: unless-stopped

  centrifugo:
    image: centrifugo/centrifugo:v5
    container_name: zilstream-centrifugo
    command: centrifugo --config=/centrifugo/config.json
    volumes:
      - ./config/centrifugo.json:/centrifugo/config.json:ro
    ports:
      - "8001:8001"  # HTTP API and WebSocket
    restart: unless-stopped
